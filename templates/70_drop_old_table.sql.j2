{#
==================================================================
Template: Drop Old Table (Jinja2)
==================================================================
Purpose: Drop old table after successful migration
==================================================================
#}
-- ==================================================================
-- DROP OLD TABLE: {{ owner }}.{{ old_table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- WARNING: This is IRREVERSIBLE!
-- 
-- IMPORTANT: This script is NOT part of master1.sql
-- Execute manually only after validating migration success
-- Recommended retention period: {{ common_settings.migration_settings.drop_old_after_days | default(7) }} days
-- ==================================================================

SET ECHO ON
SET SERVEROUTPUT ON

PROMPT ================================================================
PROMPT STANDALONE DROP SCRIPT - Execute manually after validation
PROMPT ================================================================
PROMPT Table to drop: {{ owner }}.{{ old_table_name }}
PROMPT Migration date: {{ generation_date }}
PROMPT Retention period: {{ common_settings.migration_settings.drop_old_after_days | default(7) }} days
PROMPT ================================================================

-- Pre-drop validation
DECLARE
    v_table_exists NUMBER := 0;
    v_migration_table_exists NUMBER := 0;
    v_old_row_count NUMBER := 0;
    v_new_row_count NUMBER := 0;
BEGIN
    -- Check if old table exists
    SELECT COUNT(*) INTO v_table_exists
    FROM all_tables
    WHERE owner = '{{ owner }}' AND table_name = '{{ old_table_name }}';
    
    IF v_table_exists = 0 THEN
        DBMS_OUTPUT.PUT_LINE('Table {{ owner }}.{{ old_table_name }} does not exist - nothing to drop');
        RETURN;
    END IF;
    
    -- Check if migrated table exists and is active
    SELECT COUNT(*) INTO v_migration_table_exists
    FROM all_tables
    WHERE owner = '{{ owner }}' AND table_name = '{{ table_name }}';
    
    IF v_migration_table_exists = 0 THEN
        DBMS_OUTPUT.PUT_LINE('ERROR: Migrated table {{ owner }}.{{ table_name }} not found!');
        DBMS_OUTPUT.PUT_LINE('DO NOT drop old table - migration may have failed');
        RAISE_APPLICATION_ERROR(-20001, 'Migration table not found - aborting drop');
    END IF;
    
    -- Compare row counts as final safety check
    EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM {{ owner }}.{{ old_table_name }}' INTO v_old_row_count;
    EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM {{ owner }}.{{ table_name }}' INTO v_new_row_count;
    
    DBMS_OUTPUT.PUT_LINE('Pre-drop validation:');
    DBMS_OUTPUT.PUT_LINE('  Old table rows: ' || TO_CHAR(v_old_row_count, '999,999,999,999'));
    DBMS_OUTPUT.PUT_LINE('  New table rows: ' || TO_CHAR(v_new_row_count, '999,999,999,999'));
    
    IF v_new_row_count < v_old_row_count THEN
        DBMS_OUTPUT.PUT_LINE('WARNING: New table has fewer rows than old table!');
        DBMS_OUTPUT.PUT_LINE('Difference: ' || (v_old_row_count - v_new_row_count) || ' rows');
        DBMS_OUTPUT.PUT_LINE('Verify migration was successful before dropping old table');
    END IF;
    
    DBMS_OUTPUT.PUT_LINE('✓ Pre-drop validation completed');
END;
/

-- Drop the old table with purge (no recycle bin)
PROMPT Dropping table {{ owner }}.{{ old_table_name }}...
DROP TABLE {{ owner }}.{{ old_table_name }} PURGE;

PROMPT ✓ Table {{ owner }}.{{ old_table_name }} dropped successfully

-- Post-drop verification
PROMPT Verifying table removal...
DECLARE
    v_table_count NUMBER := 0;
BEGIN
    SELECT COUNT(*) INTO v_table_count
    FROM all_tables
    WHERE owner = '{{ owner }}' AND table_name = '{{ old_table_name }}';
    
    IF v_table_count = 0 THEN
        DBMS_OUTPUT.PUT_LINE('✓ Confirmed: Table {{ owner }}.{{ old_table_name }} successfully removed');
    ELSE
        DBMS_OUTPUT.PUT_LINE('ERROR: Table still exists after DROP command');
    END IF;
END;
/

PROMPT ================================================================
PROMPT ✓ DROP OPERATION COMPLETE
PROMPT ================================================================
PROMPT Dropped: {{ owner }}.{{ old_table_name }}
PROMPT Active table: {{ owner }}.{{ table_name }}
PROMPT Date: {{ generation_date }}
PROMPT ================================================================
