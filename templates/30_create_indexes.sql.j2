{#
==================================================================
Template: Create Indexes (Jinja2)
==================================================================
Purpose: Recreate indexes on new partitioned table
==================================================================
#}
-- ==================================================================
-- CREATE INDEXES: {{ owner }}.{{ new_table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- Source: {{ owner }}.{{ table_name }}
-- Index count: {{ current_state.index_count }}
-- Parallel degree: {{ target_configuration.parallel_degree }}
-- ==================================================================

SET ECHO ON
SET TIMING ON
SET SERVEROUTPUT ON

PROMPT ================================================================
PROMPT Step 30: Creating Indexes
PROMPT ================================================================
PROMPT Target: {{ owner }}.{{ new_table_name }}
PROMPT Indexes to create: {{ current_state.index_count }}
PROMPT Estimated time: {{ (current_state.size_gb * 0.15) | estimate_time('index') }}
PROMPT ================================================================

-- Store original parallel settings
VARIABLE v_original_parallel_degree NUMBER
VARIABLE v_original_parallel_policy VARCHAR2(20)

BEGIN
    -- Store current parallel degree
    SELECT value INTO :v_original_parallel_degree 
    FROM v$parameter 
    WHERE name = 'parallel_degree';
    
    -- Store current parallel policy
    SELECT value INTO :v_original_parallel_policy 
    FROM v$parameter 
    WHERE name = 'parallel_degree_policy';
    
    DBMS_OUTPUT.PUT_LINE('Original parallel degree: ' || :v_original_parallel_degree);
    DBMS_OUTPUT.PUT_LINE('Original parallel policy: ' || :v_original_parallel_policy);
END;
/

-- Set parallel DDL for index creation only
ALTER SESSION FORCE PARALLEL DDL PARALLEL {{ target_configuration.parallel_degree }};

{%- if indexes and indexes | length > 0 %}
{%- for idx in indexes %}

-- Index: {{ idx.index_name }} ({{ idx.index_type }})
PROMPT Creating index {{ idx.index_name }}_NEW...
CREATE {% if idx.uniqueness == 'UNIQUE' %}UNIQUE {% endif %}INDEX "{{ owner }}"."{{ idx.index_name }}_NEW"
ON "{{ owner }}"."{{ new_table_name }}" ({{ idx.columns }})
{%- if idx.visibility and idx.visibility == 'INVISIBLE' %}
INVISIBLE
{%- endif %}
{%- if idx.compression == 'ENABLED' %}
{%- if idx.prefix_length and idx.prefix_length > 0 %}
COMPRESS {{ idx.prefix_length }}
{%- else %}
COMPRESS
{%- endif %}
{%- endif %}
{%- if idx.locality == 'LOCAL' or (idx.partitioned == 'YES' and not idx.locality) %}
LOCAL
{%- endif %}
TABLESPACE {{ idx.tablespace_name }}
{%- if idx.pct_free is not none %}
PCTFREE {{ idx.pct_free }}
{%- endif %}
{%- if idx.ini_trans is not none %}
INITRANS {{ idx.ini_trans }}
{%- endif %}
{%- if idx.max_trans is not none %}
MAXTRANS {{ idx.max_trans }}
{%- endif %}
{%- if idx.degree and idx.degree not in ('0', '1', 'DEFAULT') %}
PARALLEL {{ idx.degree }}
{%- else %}
NOPARALLEL
{%- endif %}
{%- if idx.is_reverse %}
REVERSE
{%- endif %};

{%- endfor %}
{%- else %}
-- No indexes found to recreate
PROMPT WARNING: No index metadata found. You may need to create indexes manually.
{%- endif %}

-- Restore original parallel settings
BEGIN
    DBMS_OUTPUT.PUT_LINE('Restoring original parallel settings...');
    DBMS_OUTPUT.PUT_LINE('Restoring parallel degree: ' || :v_original_parallel_degree);
    DBMS_OUTPUT.PUT_LINE('Restoring parallel policy: ' || :v_original_parallel_policy);
END;
/

-- Restore original parallel degree
ALTER SESSION FORCE PARALLEL DDL PARALLEL :v_original_parallel_degree;

-- Restore original parallel policy
ALTER SESSION SET PARALLEL_DEGREE_POLICY = :v_original_parallel_policy;

-- Validate index creation
PROMPT
PROMPT Validating index creation...
DECLARE
    v_index_count NUMBER;
    v_expected_count NUMBER := {{ indexes | length if indexes else 0 }};
BEGIN
    SELECT COUNT(*) INTO v_index_count
    FROM all_indexes
    WHERE owner = '{{ owner }}'
    AND (table_name = '{{ new_table_name }}_NEW' OR table_name = '{{ new_table_name }}');
    
    IF v_index_count >= v_expected_count THEN
        DBMS_OUTPUT.PUT_LINE('✓ Validation passed: ' || v_index_count || ' index(es) found (expected: ' || v_expected_count || ')');
    ELSE
        DBMS_OUTPUT.PUT_LINE('⚠ Validation warning: ' || v_index_count || ' index(es) found (expected: ' || v_expected_count || ')');
    END IF;
END;
/

PROMPT ✓ Step 30 Complete: {{ indexes | length if indexes else 0 }} index(es) created
