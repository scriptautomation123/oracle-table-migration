{#
==================================================================
Template: Master Script 1 (Jinja2)
==================================================================
Purpose: Execute steps 10-40 (structure and initial load)
==================================================================
#}
-- ==================================================================
-- MASTER SCRIPT 1: Structure Creation and Initial Load
-- ==================================================================
-- Table: {{ owner }}.{{ table_name }}
-- Generated: {{ generation_date }}
-- ==================================================================
-- This script executes:
--   Step 10: Create new partitioned table
--   Step 20: Initial data load
--   Step 30: Create indexes
--   Step 40: Delta load (optional)
-- ==================================================================

SET ECHO ON
SET SERVEROUTPUT ON SIZE UNLIMITED
SET TIMING ON
SET FEEDBACK ON

WHENEVER SQLERROR EXIT SQL.SQLCODE

PROMPT ================================================================
PROMPT MASTER SCRIPT 1: Structure and Initial Load
PROMPT ================================================================
PROMPT Table: {{ owner }}.{{ table_name }}
PROMPT Target: {{ owner }}.{{ new_table_name }}
PROMPT Size: {{ current_state.size_gb | format_size_gb }}
PROMPT Rows: {{ current_state.row_count | format_row_count }}
PROMPT Estimated Total Time: {{ (current_state.size_gb * 1.5) | estimate_time('load') }}
PROMPT ================================================================

-- Execute Step 10: Create table structure
PROMPT
PROMPT ================================================================
PROMPT Executing Step 10: Create Table Structure
PROMPT ================================================================
@@ 10_create_table.sql

-- Validate Step 10 completion
PROMPT Validating Step 10 completion...
SELECT COUNT(*) AS table_exists
FROM all_tables
WHERE owner = '{{ owner }}'
  AND table_name = '{{ new_table_name }}';

-- Execute Step 20: Initial data load  
PROMPT
PROMPT ================================================================
PROMPT Executing Step 20: Initial Data Load
PROMPT ================================================================
@@ 20_data_load.sql

-- Validate Step 20 completion
PROMPT Validating Step 20 completion...
SELECT COUNT(*) AS row_count
FROM {{ owner }}.{{ new_table_name }};

-- Execute Step 30: Create indexes
PROMPT
PROMPT ================================================================
PROMPT Executing Step 30: Create Indexes
PROMPT ================================================================
@@ 30_create_indexes.sql

-- Validate Step 30 completion
PROMPT Validating Step 30 completion...
SELECT COUNT(*) AS index_count
FROM all_indexes
WHERE owner = '{{ owner }}'
  AND table_name = '{{ new_table_name }}';

{% if include_delta_load %}
-- Execute Step 40: Delta load
PROMPT
PROMPT ================================================================
PROMPT Executing Step 40: Delta Load
PROMPT ================================================================
@@ 40_delta_load.sql

-- Validate Step 40 completion
PROMPT Validating Step 40 completion...
SELECT COUNT(*) AS final_row_count
FROM {{ owner }}.{{ new_table_name }};
{% endif %}

PROMPT
PROMPT ================================================================
PROMPT MASTER SCRIPT 1 COMPLETE
PROMPT ================================================================
PROMPT Status: SUCCESS âœ“
PROMPT Next: Review results, then run master2.sql for cutover
PROMPT ================================================================
