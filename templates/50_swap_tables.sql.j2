{#
==================================================================
Template: Swap Tables (Jinja2)
==================================================================
Purpose: Swap old and new tables (rename operation)
==================================================================
#}
-- ==================================================================
-- SWAP TABLES: {{ owner }}.{{ table_name }} <-> {{ owner }}.{{ new_table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- ==================================================================

SET ECHO ON
SET TIMING ON
SET SERVEROUTPUT ON

PROMPT ================================================================
PROMPT Step 50: Swapping Tables
PROMPT ================================================================
PROMPT Old table: {{ owner }}.{{ table_name }}
PROMPT New table: {{ owner }}.{{ new_table_name }}
PROMPT Backup: {{ owner }}.{{ old_table_name }}
PROMPT ================================================================

-- Atomic table swap using transaction-based approach 
-- All renames succeed or all fail - that's what makes it atomic
DECLARE
    v_error_message VARCHAR2(4000);
    v_original_exists NUMBER := 0;
    v_new_exists NUMBER := 0;
BEGIN
    -- Pre-swap validation
    DBMS_OUTPUT.PUT_LINE('Pre-swap validation...');
    
    -- Check original table exists
    SELECT COUNT(*) INTO v_original_exists
    FROM all_tables 
    WHERE owner = '{{ owner }}' AND table_name = '{{ table_name }}';
    
    IF v_original_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Original table {{ owner }}.{{ table_name }} not found');
    END IF;
    
    -- Check new table exists
    SELECT COUNT(*) INTO v_new_exists
    FROM all_tables 
    WHERE owner = '{{ owner }}' AND table_name = '{{ new_table_name }}';
    
    IF v_new_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'New table {{ owner }}.{{ new_table_name }} not found');
    END IF;
    
    DBMS_OUTPUT.PUT_LINE('✓ Both tables exist, proceeding with atomic swap...');
    DBMS_OUTPUT.PUT_LINE('NOTE: Oracle DDL auto-commits, but we make this atomic by ensuring both renames succeed or both fail');
    
    -- ATOMIC SWAP: Step 1 - Rename original table to _OLD
    DBMS_OUTPUT.PUT_LINE('Step 1: Renaming {{ table_name }} → {{ old_table_name }}');
    BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE {{ owner }}.{{ table_name }} RENAME TO {{ old_table_name }}';
        DBMS_OUTPUT.PUT_LINE('✓ Renamed {{ table_name }} to {{ old_table_name }}');
    EXCEPTION
        WHEN OTHERS THEN
            v_error_message := 'Step 1 failed - could not rename original table: ' || SQLERRM;
            DBMS_OUTPUT.PUT_LINE('ERROR: ' || v_error_message);
            RAISE_APPLICATION_ERROR(-20003, v_error_message);
    END;
    
    -- ATOMIC SWAP: Step 2 - Rename new table to original name
    DBMS_OUTPUT.PUT_LINE('Step 2: Renaming {{ new_table_name }} → {{ table_name }}');
    BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE {{ owner }}.{{ new_table_name }} RENAME TO {{ table_name }}';
        DBMS_OUTPUT.PUT_LINE('✓ Renamed {{ new_table_name }} to {{ table_name }}');
        DBMS_OUTPUT.PUT_LINE('✓ ATOMIC SWAP SUCCESSFUL - both renames completed');
    EXCEPTION
        WHEN OTHERS THEN
            -- Step 2 failed - rollback Step 1 to maintain atomicity
            v_error_message := 'Step 2 failed - attempting rollback of Step 1: ' || SQLERRM;
            DBMS_OUTPUT.PUT_LINE('ERROR: ' || v_error_message);
            DBMS_OUTPUT.PUT_LINE('Attempting compensatory rollback to maintain atomicity...');
            
            BEGIN
                EXECUTE IMMEDIATE 'ALTER TABLE {{ owner }}.{{ old_table_name }} RENAME TO {{ table_name }}';
                DBMS_OUTPUT.PUT_LINE('✓ Rollback successful: {{ old_table_name }} restored to {{ table_name }}');
                DBMS_OUTPUT.PUT_LINE('Status: ATOMIC SWAP FAILED - both operations rolled back');
            EXCEPTION
                WHEN OTHERS THEN
                    DBMS_OUTPUT.PUT_LINE('CRITICAL ERROR: Rollback failed!');
                    DBMS_OUTPUT.PUT_LINE('Manual intervention required:');
                    DBMS_OUTPUT.PUT_LINE('  - Original table is now: {{ owner }}.{{ old_table_name }}');
                    DBMS_OUTPUT.PUT_LINE('  - New table is still: {{ owner }}.{{ new_table_name }}');
                    DBMS_OUTPUT.PUT_LINE('  - Expected table name {{ table_name }} is unavailable');
                    RAISE_APPLICATION_ERROR(-20005, 'Atomic swap failed and rollback failed: ' || SQLERRM);
            END;
            
            RAISE_APPLICATION_ERROR(-20004, v_error_message);
    END;
    
    -- Post-swap validation
    DBMS_OUTPUT.PUT_LINE('Post-swap validation...');
    
    -- Verify old table exists with _OLD name
    SELECT COUNT(*) INTO v_original_exists
    FROM all_tables 
    WHERE owner = '{{ owner }}' AND table_name = '{{ old_table_name }}';
    
    -- Verify new table now has original name
    SELECT COUNT(*) INTO v_new_exists
    FROM all_tables 
    WHERE owner = '{{ owner }}' AND table_name = '{{ table_name }}';
    
    IF v_original_exists = 1 AND v_new_exists = 1 THEN
        DBMS_OUTPUT.PUT_LINE('✓ Post-swap validation successful');
        DBMS_OUTPUT.PUT_LINE('  - Old table: {{ owner }}.{{ old_table_name }} ✓');
        DBMS_OUTPUT.PUT_LINE('  - Active table: {{ owner }}.{{ table_name }} ✓');
    ELSE
        RAISE_APPLICATION_ERROR(-20006, 'Post-swap validation failed - unexpected table state');
    END IF;
    
    -- Check for invalidations from changing keys or loss of grants
    DBMS_OUTPUT.PUT_LINE('Checking for invalidations...');
    FOR invalid_obj IN (
        SELECT object_name, object_type, status
        FROM all_objects 
        WHERE owner = '{{ owner }}'
        AND status = 'INVALID'
        AND object_name IN ('{{ table_name }}', '{{ old_table_name }}')
    ) LOOP
        DBMS_OUTPUT.PUT_LINE('WARNING: Invalid object found: ' || invalid_obj.object_type || 
                           ' ' || invalid_obj.object_name || ' - Status: ' || invalid_obj.status);
    END LOOP;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('FATAL ERROR in atomic table swap: ' || SQLERRM);
        RAISE;
END;
/

-- Verify final state
PROMPT Verifying table swap...
BEGIN
    @plsql-util.sql READONLY check_existence {{ owner }} {{ table_name }}
    @plsql-util.sql READONLY check_existence {{ owner }} {{ old_table_name }}
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Verification error: ' || SQLERRM);
END;
/

PROMPT ✓ Step 50 Complete: Tables swapped successfully
