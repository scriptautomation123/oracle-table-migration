{#
==================================================================
Template: Dynamic Grants Script (Jinja2)
==================================================================
Purpose: Restore grants/privileges for migrated table
Note: This is a backup script - grants should be restored automatically
      Run this manually only if grant restoration fails during migration
==================================================================
#}
-- ==================================================================
-- DYNAMIC GRANTS RESTORATION: {{ owner }}.{{ table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- Purpose: Backup script to restore grants if automatic restoration fails
-- Note: This script is NOT part of the main migration workflow
-- ==================================================================

SET ECHO ON
SET SERVEROUTPUT ON

PROMPT ================================================================
PROMPT DYNAMIC GRANTS RESTORATION (BACKUP SCRIPT)
PROMPT ================================================================
PROMPT Table: {{ owner }}.{{ table_name }}
PROMPT Total grants to restore: {{ current_state.grants | length }}
PROMPT ================================================================

{% if current_state.grants | length == 0 %}
PROMPT No grants found for table {{ owner }}.{{ table_name }}
PROMPT Nothing to restore.
{% else %}
-- Restore all captured grants
{% for grant in current_state.grants %}
PROMPT Restoring {{ grant.privilege }} to {{ grant.grantee }}...
GRANT {{ grant.privilege }} ON {{ owner }}.{{ table_name }} TO {{ grant.grantee }}{% if grant.grantable == 'YES' %} WITH GRANT OPTION{% endif %};
{% endfor %}

-- Verify grants restoration
PROMPT
PROMPT ================================================================
PROMPT GRANTS VERIFICATION
PROMPT ================================================================
SELECT 
    grantee,
    privilege,
    grantable,
    'RESTORED' as status
FROM all_tab_privs
WHERE owner = '{{ owner }}'
AND table_name = '{{ table_name }}'
AND grantee NOT IN ('SYS', 'SYSTEM', 'PUBLIC')
ORDER BY grantee, privilege;

PROMPT
PROMPT ================================================================
PROMPT DYNAMIC GRANTS RESTORATION COMPLETE
PROMPT ================================================================
PROMPT Total grants expected: {{ current_state.grants | length }}
PROMPT Run the above query to verify all grants were restored correctly
PROMPT ================================================================
{% endif %}

-- Summary report
DECLARE
    v_expected_grants NUMBER := {{ current_state.grants | length }};
    v_actual_grants NUMBER := 0;
BEGIN
    SELECT COUNT(*)
    INTO v_actual_grants
    FROM all_tab_privs
    WHERE owner = '{{ owner }}'
    AND table_name = '{{ table_name }}'
    AND grantee NOT IN ('SYS', 'SYSTEM', 'PUBLIC');
    
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('GRANTS RESTORATION SUMMARY:');
    DBMS_OUTPUT.PUT_LINE('  Expected grants: ' || v_expected_grants);
    DBMS_OUTPUT.PUT_LINE('  Actual grants: ' || v_actual_grants);
    
    IF v_actual_grants = v_expected_grants THEN
        DBMS_OUTPUT.PUT_LINE('  Status: SUCCESS ✓');
    ELSE
        DBMS_OUTPUT.PUT_LINE('  Status: MISMATCH ⚠️');
        DBMS_OUTPUT.PUT_LINE('  Difference: ' || (v_expected_grants - v_actual_grants));
    END IF;
END;
/

PROMPT ================================================================