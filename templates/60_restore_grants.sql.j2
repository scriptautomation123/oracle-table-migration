{#
==================================================================
Template: Restore Grants (Jinja2)
==================================================================
Purpose: Restore object privileges from old table to new table
==================================================================
#}
-- ==================================================================
-- RESTORE GRANTS: {{ owner }}.{{ table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- ==================================================================

SET ECHO ON
SET SERVEROUTPUT ON

PROMPT ================================================================
PROMPT Step 60: Restoring Grants
PROMPT ================================================================

-- Dynamically grant privileges from old table to new table with error handling
DECLARE
    v_grant_count NUMBER := 0;
    v_failed_count NUMBER := 0;
    v_total_grants NUMBER := 0;
    v_error_message VARCHAR2(4000);
BEGIN
    -- Count total grants to process
    v_total_grants := {{ grant_statements | length if grant_statements else 0 }};
    DBMS_OUTPUT.PUT_LINE('Processing ' || v_total_grants || ' grant statements...');
    DBMS_OUTPUT.PUT_LINE('');
    
    {% if grant_statements and grant_statements | length > 0 %}
    -- Process each grant statement
    {% for grant in grant_statements %}
    BEGIN
        DBMS_OUTPUT.PUT_LINE('Executing: {{ grant }}');
        EXECUTE IMMEDIATE '{{ grant }}';
        v_grant_count := v_grant_count + 1;
        DBMS_OUTPUT.PUT_LINE('✓ Grant successful');
    EXCEPTION
        WHEN OTHERS THEN
            v_failed_count := v_failed_count + 1;
            v_error_message := SQLERRM;
            DBMS_OUTPUT.PUT_LINE('✗ Grant failed: ' || v_error_message);
            DBMS_OUTPUT.PUT_LINE('  Statement: {{ grant }}');
    END;
    {% endfor %}
    {% else %}
    DBMS_OUTPUT.PUT_LINE('No grant statements found to process');
    {% endif %}
    
    -- Summary
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('Grant restoration summary:');
    DBMS_OUTPUT.PUT_LINE('  Total grants: ' || v_total_grants);
    DBMS_OUTPUT.PUT_LINE('  Successful: ' || v_grant_count);
    DBMS_OUTPUT.PUT_LINE('  Failed: ' || v_failed_count);
    
    IF v_failed_count > 0 THEN
        DBMS_OUTPUT.PUT_LINE('');
        DBMS_OUTPUT.PUT_LINE('⚠ WARNING: ' || v_failed_count || ' grant(s) failed!');
        DBMS_OUTPUT.PUT_LINE('  Manual intervention may be required to restore privileges');
        DBMS_OUTPUT.PUT_LINE('  Check the error messages above for details');
    ELSE
        DBMS_OUTPUT.PUT_LINE('');
        DBMS_OUTPUT.PUT_LINE('✓ All grants restored successfully');
    END IF;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('FATAL ERROR in grant restoration: ' || SQLERRM);
        RAISE;
END;
/

PROMPT ✓ Step 60 Complete: Grants restored
