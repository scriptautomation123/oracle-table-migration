{#
==================================================================
Template: Create New Interval-Hash Partitioned Table (Jinja2)
==================================================================
Purpose: Creates new table with INTERVAL-HASH partitioning
         Supports both conversion and new partitioning

Context Variables:
  owner                    - Table owner/schema
  table_name              - Original table name  
  new_table_name          - New table name
  target_configuration    - Target partition config dict
    - partition_type      - INTERVAL or RANGE
    - partition_column    - Column to partition on
    - interval_type       - HOUR, DAY, WEEK, MONTH
    - interval_value      - Interval value (e.g., 1)
    - subpartition_type   - HASH or NONE
    - subpartition_column - Column to subpartition on
    - subpartition_count  - Number of hash subpartitions
    - tablespace          - Tablespace name
    - parallel_degree     - Parallel degree
    - initial_partition_value - Initial partition boundary
  column_definitions      - Column definitions string
  lob_columns            - List of LOB columns (if any)
  current_state          - Current table state dict
  migration_action       - Type of migration
==================================================================
#}
-- ==================================================================
-- CREATE TABLE: {{ owner }}.{{ new_table_name }}
-- ==================================================================
-- Generated: {{ generation_date }}
-- Migration Action: {{ migration_action }}
-- Source Table: {{ owner }}.{{ table_name }}
{%- if current_state.is_partitioned %}
-- Current Partitioning: {{ current_state.partition_type }}{% if current_state.is_interval %} (INTERVAL){% endif %}
{%- else %}
-- Current: Non-partitioned table
{%- endif %}
-- Target Partitioning: {{ target_configuration.partition_type }}{% if target_configuration.subpartition_type == 'HASH' %}-{{ target_configuration.subpartition_type }}{% endif %}
-- ==================================================================

SET ECHO ON
SET SERVEROUTPUT ON
SET TIMING ON
SET FEEDBACK ON

PROMPT ================================================================
PROMPT Step 10: Creating New Partitioned Table
PROMPT ================================================================
PROMPT Table: {{ owner }}.{{ new_table_name }}
PROMPT Partitioning: {{ target_configuration.partition_type }}{% if target_configuration.partition_type == 'INTERVAL' %} ({{ target_configuration.interval_type }}){% endif %}
PROMPT Partition Column: {{ target_configuration.partition_column }}
PROMPT Subpartitioning: {% if target_configuration.subpartition_type == 'HASH' %}HASH on {{ target_configuration.subpartition_column }}{% else %}NONE{% endif %}
PROMPT Hash Subpartitions: {% if target_configuration.subpartition_type == 'HASH' %}{{ target_configuration.subpartition_count }}{% endif %}
PROMPT Tablespace: {{ target_configuration.tablespace }}
{% if current_state.lob_count > 0 %}
PROMPT LOB Columns: {{ current_state.lob_count }}
{% endif %}
PROMPT ================================================================

-- Check if table already exists (generic)
@validation/check_table_exists.sql {{ owner }} {{ new_table_name }}

-- Create new table with partitioning
PROMPT

PROMPT Creating table {{ owner }}.{{ new_table_name }}...
PROMPT Estimated time: {{ current_state.size_gb | estimate_time('load') }}



CREATE TABLE "{{ owner }}"."{{ new_table_name }}"
(
{%- for col in columns %}
    {{ col.name }} {{ col.type }}{% if col.type in ['VARCHAR2', 'CHAR', 'NVARCHAR2', 'NCHAR'] and col.char_length %}({{ col.char_length }}){% elif col.type == 'NUMBER' and col.precision %}({{ col.precision }}{% if col.scale is not none %},{{ col.scale }}{% endif %}){% endif %}{% if col.default %} DEFAULT {{ col.default }}{% endif %}{% if col.nullable == 'N' %} NOT NULL{% endif %}{% if not loop.last %},{% endif %}
{%- endfor %}
)
{%- if storage_parameters and storage_parameters.compression and storage_parameters.compression != 'DISABLED' %}
COMPRESS FOR {{ storage_parameters.compress_for | default('OLTP') }}
{%- endif %}
TABLESPACE {{ target_configuration.tablespace }}
{%- if storage_parameters %}
PCTFREE {{ storage_parameters.pct_free if storage_parameters.pct_free else '10' }}
INITRANS {{ storage_parameters.ini_trans if storage_parameters.ini_trans else '1' }}
MAXTRANS {{ storage_parameters.max_trans if storage_parameters.max_trans else '255' }}
STORAGE (
    INITIAL {{ storage_parameters.initial_extent if storage_parameters.initial_extent else '10240M' }}
    NEXT {{ storage_parameters.next_extent if storage_parameters.next_extent else '10240M' }}
    BUFFER_POOL {{ storage_parameters.buffer_pool if storage_parameters.buffer_pool else 'DEFAULT' }}
)
{%- endif %}

{%- if target_configuration.partition_type == 'INTERVAL' or target_configuration.partition_type == 'RANGE' %}
PARTITION BY RANGE ({{ target_configuration.partition_column }})
INTERVAL ({{ target_configuration.interval_type | format_interval(target_configuration.interval_value) }})
{%- if target_configuration.subpartition_type == 'HASH' %}
SUBPARTITION BY HASH ({{ target_configuration.subpartition_column }})
{%- if lob_storage and lob_storage | length > 0 %}
SUBPARTITION TEMPLATE
(
{%- for i in range(4) %}
    SUBPARTITION sp{{ i }}
{%- for lob in lob_storage %}
        LOB ({{ lob.column_name }}) STORE AS {{ lob.segment_name }}_{{ i }} (TABLESPACE {{ lob.tablespace_name }}_{{ '%02d' | format((i % 4) + 1) }}){% if not loop.last %},{% endif %}
{%- endfor %}
{%- if not loop.last %},{% endif %}
{%- endfor %}
)
{%- else %}
SUBPARTITIONS {{ target_configuration.subpartition_count if not lob_storage or lob_storage | length == 0 else 4 }}
{%- endif %}
{%- endif %}
(
    PARTITION p_seed VALUES LESS THAN ({{ target_configuration.initial_partition_value }})
)
{%- endif %}
ENABLE ROW MOVEMENT;

PROMPT âœ“ Table {{ owner }}.{{ new_table_name }} created successfully


-- Post-create table checks (structure, partitioning, LOBs, stats)
@validation/post_create_table_checks.sql {{ owner }} {{ new_table_name }} {{ target_configuration.parallel_degree }}

PROMPT
PROMPT ================================================================
PROMPT Step 10 Complete: Table Structure Created
PROMPT ================================================================
PROMPT Status: SUCCESS
PROMPT Table: {{ owner }}.{{ new_table_name }}
{%- if target_configuration.partition_type == 'INTERVAL' %}
PROMPT Partitioning: INTERVAL-{% if target_configuration.subpartition_type == 'HASH' %}HASH{% else %}ONLY{% endif %}
{%- endif %}
PROMPT
PROMPT Next Steps:
PROMPT   1. Review table structure above
PROMPT   2. Run 20_data_load.sql to load data (est. {{ current_state.size_gb | estimate_time('load') }})
PROMPT   3. Monitor space and performance
PROMPT ================================================================
