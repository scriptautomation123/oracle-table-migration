-- =====================================================
-- VIEW WITH INSTEAD OF TRIGGERS FOR _NEW AND _OLD TABLES
-- =====================================================

-- Create _old table
CREATE TABLE employees_old (
    emp_id NUMBER PRIMARY KEY,
    emp_name VARCHAR2(100) NOT NULL,
    department VARCHAR2(50),
    salary NUMBER,
    status VARCHAR2(20)
);

-- Create _new table
CREATE TABLE employees_new (
    emp_id NUMBER PRIMARY KEY,
    emp_name VARCHAR2(100) NOT NULL,
    department VARCHAR2(50),
    salary NUMBER,
    status VARCHAR2(20)
);

-- Create view joining both tables
CREATE OR REPLACE VIEW employees_view AS
SELECT * FROM employees_old
UNION ALL
SELECT * FROM employees_new;

-- INSTEAD OF INSERT trigger
CREATE OR REPLACE TRIGGER trg_employees_insert
INSTEAD OF INSERT ON employees_view
FOR EACH ROW
BEGIN
    INSERT INTO employees_new (emp_id, emp_name, department, salary, status)
    VALUES (:NEW.emp_id, :NEW.emp_name, :NEW.department, :NEW.salary, :NEW.status);
END;
/

-- INSTEAD OF UPDATE trigger
CREATE OR REPLACE TRIGGER trg_employees_update
INSTEAD OF UPDATE ON employees_view
FOR EACH ROW
DECLARE
    v_count NUMBER;
BEGIN
    -- Check if in new table
    SELECT COUNT(*) INTO v_count FROM employees_new WHERE emp_id = :OLD.emp_id;
    
    IF v_count > 0 THEN
        UPDATE employees_new
        SET emp_name = :NEW.emp_name,
            department = :NEW.department,
            salary = :NEW.salary,
            status = :NEW.status
        WHERE emp_id = :OLD.emp_id;
    ELSE
        UPDATE employees_old
        SET emp_name = :NEW.emp_name,
            department = :NEW.department,
            salary = :NEW.salary,
            status = :NEW.status
        WHERE emp_id = :OLD.emp_id;
    END IF;
END;
/

-- INSTEAD OF DELETE trigger
CREATE OR REPLACE TRIGGER trg_employees_delete
INSTEAD OF DELETE ON employees_view
FOR EACH ROW
DECLARE
    v_count NUMBER;
BEGIN
    -- Check if in new table
    SELECT COUNT(*) INTO v_count FROM employees_new WHERE emp_id = :OLD.emp_id;
    
    IF v_count > 0 THEN
        DELETE FROM employees_new WHERE emp_id = :OLD.emp_id;
    ELSE
        DELETE FROM employees_old WHERE emp_id = :OLD.emp_id;
    END IF;
END;
/
